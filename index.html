<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Finance Intelligence Â· CarpinterIA</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
<style>
:root {
  --bg: #0a0e17; --bg2: #111827; --bg3: #1a2235; --bg4: #243049;
  --tx: #e2e8f0; --tx2: #94a3b8; --tx3: #64748b;
  --acc: #38bdf8; --acc2: #0ea5e9; --green: #22c55e; --green2: #16a34a;
  --red: #ef4444; --red2: #dc2626; --amber: #f59e0b; --purple: #a78bfa;
  --pink: #f472b6; --teal: #2dd4bf;
  --radius: 12px; --shadow: 0 4px 24px rgba(0,0,0,0.4);
}
* { margin:0; padding:0; box-sizing:border-box; }
body { font-family:'DM Sans',sans-serif; background:var(--bg); color:var(--tx); min-height:100vh; }
.mono { font-family:'JetBrains Mono',monospace; }

/* Header */
.header { background:linear-gradient(135deg, var(--bg2) 0%, var(--bg3) 100%); border-bottom:1px solid var(--bg4); padding:16px 24px; display:flex; align-items:center; justify-content:space-between; position:sticky; top:0; z-index:100; backdrop-filter:blur(12px); }
.header h1 { font-size:18px; font-weight:700; display:flex; align-items:center; gap:10px; }
.header h1 span { color:var(--acc); }
.header-right { display:flex; align-items:center; gap:12px; }
.sync-badge { font-size:11px; padding:4px 10px; border-radius:20px; background:rgba(34,197,94,0.15); color:var(--green); border:1px solid rgba(34,197,94,0.3); }
.sync-badge.stale { background:rgba(245,158,11,0.15); color:var(--amber); border-color:rgba(245,158,11,0.3); }
.btn { padding:8px 16px; border-radius:8px; border:1px solid var(--bg4); background:var(--bg3); color:var(--tx); cursor:pointer; font-size:13px; font-family:inherit; font-weight:500; transition:all 0.2s; }
.btn:hover { background:var(--bg4); border-color:var(--acc); }
.btn.primary { background:var(--acc2); color:white; border-color:var(--acc); }
.btn.primary:hover { background:var(--acc); }
.btn.small { padding:5px 10px; font-size:11px; }

/* Tabs */
.tabs { display:flex; gap:2px; padding:12px 24px 0; background:var(--bg); overflow-x:auto; }
.tab { padding:10px 20px; cursor:pointer; font-size:13px; font-weight:500; border-radius:8px 8px 0 0; color:var(--tx3); transition:all 0.2s; border:1px solid transparent; border-bottom:none; white-space:nowrap; }
.tab:hover { color:var(--tx2); background:var(--bg2); }
.tab.active { color:var(--acc); background:var(--bg2); border-color:var(--bg4); }

/* Main */
.main { padding:20px 24px; max-width:1600px; margin:0 auto; }
.section { display:none; }
.section.active { display:block; }

/* Grid */
.grid { display:grid; gap:16px; }
.g2 { grid-template-columns:repeat(2,1fr); }
.g3 { grid-template-columns:repeat(3,1fr); }
.g4 { grid-template-columns:repeat(4,1fr); }
@media(max-width:1200px) { .g4 { grid-template-columns:repeat(2,1fr); } }
@media(max-width:768px) { .g2,.g3,.g4 { grid-template-columns:1fr; } }

/* Cards */
.card { background:var(--bg2); border:1px solid var(--bg4); border-radius:var(--radius); padding:20px; }
.card-head { display:flex; justify-content:space-between; align-items:center; margin-bottom:16px; }
.card-head h3 { font-size:14px; font-weight:600; color:var(--tx2); text-transform:uppercase; letter-spacing:0.5px; }
.card-head .badge { font-size:11px; padding:3px 8px; border-radius:12px; font-weight:500; }

/* KPI Cards */
.kpi { background:var(--bg2); border:1px solid var(--bg4); border-radius:var(--radius); padding:20px; position:relative; overflow:hidden; }
.kpi::after { content:''; position:absolute; top:0; left:0; right:0; height:3px; }
.kpi.blue::after { background:linear-gradient(90deg,var(--acc),var(--purple)); }
.kpi.green::after { background:linear-gradient(90deg,var(--green),var(--teal)); }
.kpi.red::after { background:linear-gradient(90deg,var(--red),var(--pink)); }
.kpi.amber::after { background:linear-gradient(90deg,var(--amber),#fb923c); }
.kpi-label { font-size:12px; color:var(--tx3); margin-bottom:6px; text-transform:uppercase; letter-spacing:0.5px; }
.kpi-value { font-size:28px; font-weight:700; line-height:1.1; }
.kpi-sub { font-size:12px; color:var(--tx3); margin-top:6px; }
.kpi-value.sm { font-size:20px; }

/* Tables */
.tbl { width:100%; border-collapse:collapse; font-size:13px; }
.tbl th { text-align:left; padding:8px 10px; color:var(--tx3); font-weight:500; font-size:11px; text-transform:uppercase; letter-spacing:0.5px; border-bottom:1px solid var(--bg4); }
.tbl td { padding:8px 10px; border-bottom:1px solid rgba(255,255,255,0.04); }
.tbl tr:hover td { background:rgba(56,189,248,0.04); }
.tbl .num { text-align:right; font-family:'JetBrains Mono',monospace; font-size:12px; }

/* Risk badges */
.risk { padding:2px 8px; border-radius:10px; font-size:11px; font-weight:600; }
.risk.bajo { background:rgba(34,197,94,0.15); color:var(--green); }
.risk.medio { background:rgba(56,189,248,0.15); color:var(--acc); }
.risk.alto { background:rgba(245,158,11,0.15); color:var(--amber); }
.risk.critico { background:rgba(239,68,68,0.15); color:var(--red); }

/* Alerts */
.alert-card { padding:14px 16px; border-radius:10px; margin-bottom:8px; border-left:4px solid; cursor:pointer; transition:all 0.2s; }
.alert-card:hover { transform:translateX(4px); }
.alert-card.critical { background:rgba(239,68,68,0.08); border-color:var(--red); }
.alert-card.warning { background:rgba(245,158,11,0.08); border-color:var(--amber); }
.alert-card.info { background:rgba(56,189,248,0.08); border-color:var(--acc); }
.alert-card.opportunity { background:rgba(34,197,94,0.08); border-color:var(--green); }
.alert-title { font-weight:600; font-size:13px; margin-bottom:4px; }
.alert-desc { font-size:12px; color:var(--tx2); }
.alert-rec { font-size:11px; color:var(--tx3); margin-top:6px; font-style:italic; }
.alert-actions { display:flex; gap:6px; margin-top:8px; }

/* Progress bar */
.pbar { height:8px; background:var(--bg4); border-radius:4px; overflow:hidden; }
.pbar-fill { height:100%; border-radius:4px; transition:width 0.6s ease; }

/* Chart containers */
.chart-wrap { position:relative; height:300px; }
.chart-wrap.sm { height:200px; }

/* Loading */
.loading { display:flex; align-items:center; justify-content:center; padding:40px; color:var(--tx3); }
.spinner { width:20px; height:20px; border:2px solid var(--bg4); border-top-color:var(--acc); border-radius:50%; animation:spin 0.8s linear infinite; margin-right:10px; }
@keyframes spin { to { transform:rotate(360deg); } }

/* Insight cards */
.insight { padding:12px 16px; background:var(--bg3); border-radius:8px; font-size:13px; color:var(--tx2); margin-bottom:8px; line-height:1.5; border-left:3px solid var(--acc); }

/* Client modal */
.modal-overlay { display:none; position:fixed; inset:0; background:rgba(0,0,0,0.7); z-index:200; justify-content:center; align-items:flex-start; padding:40px; overflow-y:auto; }
.modal-overlay.open { display:flex; }
.modal { background:var(--bg2); border:1px solid var(--bg4); border-radius:var(--radius); width:100%; max-width:900px; padding:24px; }
.modal-head { display:flex; justify-content:space-between; align-items:center; margin-bottom:20px; }
.modal-close { background:none; border:none; color:var(--tx3); font-size:20px; cursor:pointer; }
</style>
</head>
<body>

<div class="header">
  <h1>ğŸ“Š <span>Finance Intelligence</span> Â· CarpinterIA</h1>
  <div class="header-right">
    <div class="sync-badge" id="syncBadge">Cargando...</div>
    <button class="btn small" onclick="runIntelligence()">ğŸ§  Analizar</button>
    <button class="btn small" onclick="takeSnapshot()">ğŸ“¸ Snapshot</button>
  </div>
</div>

<div class="tabs">
  <div class="tab active" onclick="showTab('overview')">Resumen</div>
  <div class="tab" onclick="showTab('aging')">Aging CxC</div>
  <div class="tab" onclick="showTab('cxp')">CxP</div>
  <div class="tab" onclick="showTab('forecast')">Forecast</div>
  <div class="tab" onclick="showTab('alerts')">Alertas</div>
  <div class="tab" onclick="showTab('concentration')">ConcentraciÃ³n</div>
</div>

<div class="main">
  <!-- OVERVIEW -->
  <div class="section active" id="sec-overview">
    <div class="grid g4" id="kpiGrid" style="margin-bottom:20px;"></div>
    <div class="grid g2" style="margin-bottom:20px;">
      <div class="card">
        <div class="card-head"><h3>Aging CxC (USD)</h3></div>
        <div class="chart-wrap sm"><canvas id="chartAging"></canvas></div>
      </div>
      <div class="card">
        <div class="card-head"><h3>Alertas Activas</h3></div>
        <div id="alertsOverview" style="max-height:240px;overflow-y:auto;"></div>
      </div>
    </div>
    <div class="grid g2">
      <div class="card">
        <div class="card-head"><h3>Top Deudores</h3></div>
        <div id="topDeudores" style="max-height:320px;overflow-y:auto;"></div>
      </div>
      <div class="card">
        <div class="card-head"><h3>Top Proveedores</h3></div>
        <div id="topProveedores" style="max-height:320px;overflow-y:auto;"></div>
      </div>
    </div>
  </div>

  <!-- AGING -->
  <div class="section" id="sec-aging">
    <div class="grid g3" id="agingKpis" style="margin-bottom:20px;"></div>
    <div class="grid g2" style="margin-bottom:20px;">
      <div class="card">
        <div class="card-head"><h3>Aging por Tramo (USD)</h3></div>
        <div class="chart-wrap"><canvas id="chartAgingDetail"></canvas></div>
      </div>
      <div class="card">
        <div class="card-head"><h3>ProvisiÃ³n por Tramo</h3></div>
        <div class="chart-wrap"><canvas id="chartProvision"></canvas></div>
      </div>
    </div>
    <div class="card" style="margin-bottom:20px;">
      <div class="card-head"><h3>Insights del Experto</h3></div>
      <div id="agingInsights"></div>
    </div>
    <div class="card">
      <div class="card-head"><h3>Clientes por Riesgo</h3></div>
      <div id="agingClients" style="overflow-x:auto;"></div>
    </div>
  </div>

  <!-- CxP -->
  <div class="section" id="sec-cxp">
    <div class="card">
      <div class="card-head"><h3>Cuentas por Pagar</h3></div>
      <div id="cxpTable" style="overflow-x:auto;"></div>
    </div>
  </div>

  <!-- FORECAST -->
  <div class="section" id="sec-forecast">
    <div class="grid g3" id="forecastParams" style="margin-bottom:20px;"></div>
    <div class="card" style="margin-bottom:20px;">
      <div class="card-head">
        <h3>ProyecciÃ³n de Cash Flow</h3>
        <div>
          <button class="btn small" onclick="loadForecast(90)">90d</button>
          <button class="btn small" onclick="loadForecast(180)">180d</button>
        </div>
      </div>
      <div class="chart-wrap"><canvas id="chartForecast"></canvas></div>
    </div>
  </div>

  <!-- ALERTS -->
  <div class="section" id="sec-alerts">
    <div class="card">
      <div class="card-head">
        <h3>Motor de Inteligencia Financiera</h3>
        <button class="btn primary small" onclick="runIntelligence()">ğŸ§  Ejecutar AnÃ¡lisis</button>
      </div>
      <div id="alertsFull"></div>
    </div>
  </div>

  <!-- CONCENTRATION -->
  <div class="section" id="sec-concentration">
    <div class="grid g3" id="concKpis" style="margin-bottom:20px;"></div>
    <div class="grid g2">
      <div class="card">
        <div class="card-head"><h3>Curva de ConcentraciÃ³n (Pareto)</h3></div>
        <div class="chart-wrap"><canvas id="chartConc"></canvas></div>
      </div>
      <div class="card">
        <div class="card-head"><h3>DistribuciÃ³n por Cliente</h3></div>
        <div class="chart-wrap"><canvas id="chartConcPie"></canvas></div>
      </div>
    </div>
  </div>
</div>

<!-- Client Modal -->
<div class="modal-overlay" id="clientModal">
  <div class="modal">
    <div class="modal-head">
      <h2 id="modalClientName" style="font-size:18px;">Cliente</h2>
      <button class="modal-close" onclick="closeModal()">&times;</button>
    </div>
    <div id="modalContent"><div class="loading"><div class="spinner"></div>Cargando perfil...</div></div>
  </div>
</div>

<script>
const SB_URL = 'https://qnjizqowddtvzzfillmo.supabase.co'
const SB_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InFuaml6cW93ZGR0dnp6ZmlsbG1vIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Mzc1NTcyMDMsImV4cCI6MjA1MzEzMzIwM30.jM4FMm4Ey_JD-5lcTrkWxHpAtpkXJScFIl3WJnEcjJk'
const INT_URL = `${SB_URL}/functions/v1/finance-intelligence`
const FIN_URL = `${SB_URL}/functions/v1/finance-agent-api-v2`
const hdr = {'Content-Type':'application/json','Authorization':`Bearer ${SB_KEY}`,'apikey':SB_KEY}

let charts = {}
const fmt = (n,d=0) => n !== undefined && n !== null ? Number(n).toLocaleString('es-UY',{minimumFractionDigits:d,maximumFractionDigits:d}) : '0'
const fmtK = (n) => { if(!n)return'0';if(Math.abs(n)>=1e6)return(n/1e6).toFixed(1)+'M';if(Math.abs(n)>=1e3)return(n/1e3).toFixed(0)+'K';return fmt(n) }

function showTab(id) {
  document.querySelectorAll('.tab').forEach((t,i) => {
    t.classList.toggle('active', t.textContent.toLowerCase().includes(id.substring(0,4)) || (id==='overview' && i===0))
  })
  document.querySelectorAll('.section').forEach(s => s.classList.toggle('active', s.id === 'sec-'+id))
  if(id==='aging' && !agingLoaded) loadAging()
  if(id==='forecast' && !forecastLoaded) loadForecast(90)
  if(id==='concentration' && !concLoaded) loadConcentration()
  if(id==='alerts' && !alertsLoaded) loadAlerts()
  if(id==='cxp' && !cxpLoaded) loadCxP()
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// OVERVIEW
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function loadDashboard() {
  try {
    const res = await fetch(`${FIN_URL}?action=dashboard`, {headers:hdr})
    const d = await res.json()
    const h = d.financial_health || {}
    
    // Sync badge
    const sb = document.getElementById('syncBadge')
    if(d.last_zeta_sync) {
      const ago = Math.floor((Date.now() - new Date(d.last_zeta_sync).getTime()) / 3600000)
      sb.textContent = ago < 24 ? `Zeta sync: ${ago}h` : `Zeta sync: ${Math.floor(ago/24)}d`
      sb.className = 'sync-badge' + (ago > 24 ? ' stale' : '')
    }

    // KPIs
    document.getElementById('kpiGrid').innerHTML = `
      <div class="kpi blue"><div class="kpi-label">PosiciÃ³n Neta</div><div class="kpi-value">U$S ${fmtK(h.net_position)}</div><div class="kpi-sub">Cash + CxC - CxP</div></div>
      <div class="kpi ${h.days_of_operation<15?'red':h.days_of_operation<45?'amber':'green'}"><div class="kpi-label">DÃ­as de OperaciÃ³n</div><div class="kpi-value">${fmt(h.days_of_operation)}</div><div class="kpi-sub">Burn: U$S ${fmtK(h.monthly_burn_rate)}/mes</div></div>
      <div class="kpi ${h.cxc_vencida_pct>80?'red':h.cxc_vencida_pct>50?'amber':'green'}"><div class="kpi-label">CxC Vencida</div><div class="kpi-value">${fmt(h.cxc_vencida_pct,1)}%</div><div class="kpi-sub">U$S ${fmtK(h.cxc_vencida_usd)} de ${fmtK(h.receivables_usd)}</div></div>
      <div class="kpi amber"><div class="kpi-label">ProvisiÃ³n Incobrables</div><div class="kpi-value sm">U$S ${fmtK(h.provision_usd)}</div><div class="kpi-sub">TC ref: ${h.tc_reference}</div></div>
    `

    // Aging chart
    if(d.aging_chart) {
      const colors = ['#22c55e','#f59e0b','#f97316','#ef4444']
      if(charts.aging) charts.aging.destroy()
      charts.aging = new Chart(document.getElementById('chartAging'), {
        type:'doughnut',
        data:{
          labels:d.aging_chart.map(a=>a.label),
          datasets:[{data:d.aging_chart.map(a=>a.usd),backgroundColor:colors,borderWidth:0}]
        },
        options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{position:'right',labels:{color:'#94a3b8',font:{size:11}}}}}
      })
    }

    // Alerts overview
    const alertsHtml = (d.active_alerts||[]).slice(0,5).map(a => `
      <div class="alert-card ${a.severidad}">
        <div class="alert-title">${a.titulo}</div>
        <div class="alert-desc">${a.descripcion}</div>
      </div>
    `).join('') || '<div style="color:var(--tx3);padding:20px;text-align:center;">Sin alertas activas</div>'
    document.getElementById('alertsOverview').innerHTML = alertsHtml

    // Top deudores
    document.getElementById('topDeudores').innerHTML = `<table class="tbl"><thead><tr><th>Cliente</th><th>Mon</th><th class="num">Deuda</th><th class="num">DÃ­as</th></tr></thead><tbody>${
      (d.cxc_top||[]).map(c => `<tr style="cursor:pointer;" onclick="openClient('${c.cliente.replace(/'/g,"\\'")}')"><td>${c.cliente}</td><td>${c.moneda}</td><td class="num">${fmt(c.total)}</td><td class="num">${c.dias_max}d</td></tr>`).join('')
    }</tbody></table>`

    // Top proveedores
    document.getElementById('topProveedores').innerHTML = `<table class="tbl"><thead><tr><th>Proveedor</th><th>Mon</th><th class="num">Deuda</th></tr></thead><tbody>${
      (d.cxp_top||[]).map(c => `<tr><td>${c.proveedor}</td><td>${c.moneda}</td><td class="num">${fmt(c.total)}</td></tr>`).join('')
    }</tbody></table>`

  } catch(e) { console.error('Dashboard error:', e) }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// AGING
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let agingLoaded = false
async function loadAging() {
  try {
    const res = await fetch(`${INT_URL}?action=aging`,{headers:hdr})
    const d = await res.json()
    agingLoaded = true
    const t = d.totals||{}

    document.getElementById('agingKpis').innerHTML = `
      <div class="kpi blue"><div class="kpi-label">CxC Total USD</div><div class="kpi-value">U$S ${fmtK(t.cxc_total_usd)}</div><div class="kpi-sub">${t.clientes_con_deuda} clientes</div></div>
      <div class="kpi ${t.provision_pct>20?'red':'amber'}"><div class="kpi-label">ProvisiÃ³n</div><div class="kpi-value sm">U$S ${fmtK(t.provision_total_usd)}</div><div class="kpi-sub">${fmt(t.provision_pct,1)}% del total</div></div>
      <div class="kpi ${t.clientes_riesgo_alto>3?'red':'amber'}"><div class="kpi-label">Clientes Alto Riesgo</div><div class="kpi-value">${t.clientes_riesgo_alto}</div><div class="kpi-sub">Score >= 4.0</div></div>
    `

    // Aging bar chart - group by tramo
    const tramos = ['corriente','31-60d','61-90d','91-180d','181-365d','>365d']
    const tramoLabels = ['0-30d','31-60d','61-90d','91-180d','181-365d','>365d']
    const usdData = tramos.map(tr => d.aging_summary.filter(a=>a.tramo===tr&&a.moneda==='U$S').reduce((s,a)=>s+a.usd,0))
    const otherData = tramos.map(tr => d.aging_summary.filter(a=>a.tramo===tr&&a.moneda!=='U$S').reduce((s,a)=>s+a.usd,0))

    if(charts.agingD) charts.agingD.destroy()
    charts.agingD = new Chart(document.getElementById('chartAgingDetail'),{
      type:'bar',
      data:{labels:tramoLabels,datasets:[
        {label:'USD',data:usdData,backgroundColor:'rgba(56,189,248,0.7)',borderRadius:4},
        {label:'UYU+EUR',data:otherData,backgroundColor:'rgba(167,139,250,0.7)',borderRadius:4},
      ]},
      options:{responsive:true,maintainAspectRatio:false,scales:{x:{stacked:true,ticks:{color:'#64748b'}},y:{stacked:true,ticks:{color:'#64748b',callback:v=>'$'+fmtK(v)},grid:{color:'rgba(255,255,255,0.05)'}}},plugins:{legend:{labels:{color:'#94a3b8'}}}}
    })

    // Provision chart
    const provData = tramos.map(tr => d.aging_summary.filter(a=>a.tramo===tr).reduce((s,a)=>s+a.provUsd,0))
    if(charts.prov) charts.prov.destroy()
    charts.prov = new Chart(document.getElementById('chartProvision'),{
      type:'bar',
      data:{labels:tramoLabels,datasets:[{label:'ProvisiÃ³n USD',data:provData,backgroundColor:['rgba(34,197,94,0.4)','rgba(56,189,248,0.5)','rgba(245,158,11,0.5)','rgba(251,146,60,0.5)','rgba(239,68,68,0.5)','rgba(220,38,38,0.7)'],borderRadius:4}]},
      options:{responsive:true,maintainAspectRatio:false,scales:{x:{ticks:{color:'#64748b'}},y:{ticks:{color:'#64748b',callback:v=>'$'+fmtK(v)},grid:{color:'rgba(255,255,255,0.05)'}}},plugins:{legend:{display:false}}}
    })

    // Insights
    document.getElementById('agingInsights').innerHTML = (d.insights||[]).map(i=>`<div class="insight">${i}</div>`).join('')

    // Clients table
    const cls = d.clientes_top||[]
    document.getElementById('agingClients').innerHTML = `<table class="tbl"><thead><tr><th>Cliente</th><th>Mon</th><th class="num">Saldo</th><th class="num">USD</th><th>Riesgo</th><th class="num">Score</th><th class="num">DÃ­as</th><th class="num">ProvisiÃ³n</th></tr></thead><tbody>${
      cls.map(c=>`<tr style="cursor:pointer;" onclick="openClient('${c.cliente.replace(/'/g,"\\'")}')"><td>${c.cliente}</td><td>${c.moneda}</td><td class="num">${fmt(c.saldo)}</td><td class="num">${fmt(c.usd)}</td><td><span class="risk ${c.riesgo}">${c.riesgo}</span></td><td class="num">${c.score}</td><td class="num">${c.diasMax}d</td><td class="num">${fmt(c.prov)}</td></tr>`).join('')
    }</tbody></table>`

  } catch(e) { console.error('Aging error:', e) }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// CxP
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let cxpLoaded = false
async function loadCxP() {
  try {
    const res = await fetch(`${FIN_URL}?action=cxp`,{headers:hdr})
    const d = await res.json()
    cxpLoaded = true
    const rows = d.top_proveedores || d.proveedores || []
    document.getElementById('cxpTable').innerHTML = `<table class="tbl"><thead><tr><th>Proveedor</th><th>Mon</th><th class="num">Comprobantes</th><th class="num">Deuda Total</th><th>Estado</th></tr></thead><tbody>${
      rows.map(r=>`<tr><td>${r.proveedor||r.proveedor_nombre}</td><td>${r.moneda||r.moneda_simbolo}</td><td class="num">${r.comprobantes||r.n||'-'}</td><td class="num">${fmt(r.total||r.deuda_total)}</td><td><span class="risk ${(r.estado_pago||'').includes('critico')?'critico':(r.estado_pago||'').includes('antiguo')?'alto':(r.estado_pago||'').includes('reciente')?'medio':'bajo'}">${r.estado_pago||'corriente'}</span></td></tr>`).join('')
    }</tbody></table>`
  } catch(e) { console.error('CxP error:', e) }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// FORECAST
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let forecastLoaded = false
async function loadForecast(days) {
  try {
    const res = await fetch(`${INT_URL}?action=forecast&days=${days}&scenario=all`,{headers:hdr})
    const d = await res.json()
    forecastLoaded = true
    const p = d.parameters||{}

    document.getElementById('forecastParams').innerHTML = `
      <div class="kpi blue"><div class="kpi-label">Balance Inicial</div><div class="kpi-value sm">U$S ${fmtK(p.starting_balance)}</div></div>
      <div class="kpi amber"><div class="kpi-label">Burn Diario</div><div class="kpi-value sm">U$S ${fmt(p.daily_burn)}</div></div>
      <div class="kpi green"><div class="kpi-label">CxC Corriente</div><div class="kpi-value sm">U$S ${fmtK(p.cxc_corriente)}</div></div>
    `

    if(charts.forecast) charts.forecast.destroy()
    const datasets = (d.scenarios||[]).map(sc => ({
      label:sc.label, data:sc.points.map(p=>({x:p.date,y:p.balance})),
      borderColor:sc.color, backgroundColor:sc.color+'20', fill:sc.key==='base',
      tension:0.3, pointRadius:0, borderWidth:2
    }))
    // Zero line
    datasets.push({label:'Cero',data:(d.scenarios?.[0]?.points||[]).map(p=>({x:p.date,y:0})),borderColor:'rgba(255,255,255,0.2)',borderDash:[5,5],pointRadius:0,borderWidth:1,fill:false})

    charts.forecast = new Chart(document.getElementById('chartForecast'),{
      type:'line',
      data:{datasets},
      options:{responsive:true,maintainAspectRatio:false,scales:{x:{type:'category',labels:(d.scenarios?.[0]?.points||[]).map(p=>p.date),ticks:{color:'#64748b',maxTicksLimit:10}},y:{ticks:{color:'#64748b',callback:v=>'$'+fmtK(v)},grid:{color:'rgba(255,255,255,0.05)'}}},plugins:{legend:{labels:{color:'#94a3b8'}},tooltip:{callbacks:{label:ctx=>ctx.dataset.label+': U$S '+fmt(ctx.parsed.y)}}},interaction:{intersect:false,mode:'index'}}
    })
  } catch(e) { console.error('Forecast error:', e) }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ALERTS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let alertsLoaded = false
async function loadAlerts() {
  try {
    const res = await fetch(`${INT_URL}?action=alerts`,{headers:hdr})
    const d = await res.json()
    alertsLoaded = true
    renderAlertsFull(d.alerts||[])
  } catch(e) { console.error('Alerts error:', e) }
}

function renderAlertsFull(alerts) {
  if(!alerts.length) {
    document.getElementById('alertsFull').innerHTML = '<div style="text-align:center;padding:40px;color:var(--tx3);">Sin alertas. Ejecuta el anÃ¡lisis para generar.</div>'
    return
  }
  document.getElementById('alertsFull').innerHTML = alerts.map(a => `
    <div class="alert-card ${a.severidad}">
      <div class="alert-title">${a.titulo}</div>
      <div class="alert-desc">${a.descripcion}</div>
      ${a.recomendacion?`<div class="alert-rec">ğŸ’¡ ${a.recomendacion}</div>`:''}
      <div class="alert-actions">
        <button class="btn small" onclick="resolveAlert('${a.id}','resuelta')">âœ“ Resolver</button>
        <button class="btn small" onclick="resolveAlert('${a.id}','descartada')">âœ— Descartar</button>
      </div>
    </div>
  `).join('')
}

async function resolveAlert(id, action) {
  await fetch(`${INT_URL}?action=resolve-alert`,{method:'POST',headers:hdr,body:JSON.stringify({id,action,by:'seba'})})
  loadAlerts()
}

async function runIntelligence() {
  const res = await fetch(`${INT_URL}?action=intelligence`,{headers:hdr})
  const d = await res.json()
  renderAlertsFull(d.alerts||[])
  alertsLoaded = true
  showTab('alerts')
  loadDashboard()
}

async function takeSnapshot() {
  await fetch(`${INT_URL}?action=daily-snapshot`,{headers:hdr})
  alert('Snapshot guardado')
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// CONCENTRATION
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let concLoaded = false
async function loadConcentration() {
  try {
    const res = await fetch(`${INT_URL}?action=concentration`,{headers:hdr})
    const d = await res.json()
    concLoaded = true

    document.getElementById('concKpis').innerHTML = `
      <div class="kpi ${d.hhi>2500?'red':d.hhi>1500?'amber':'green'}"><div class="kpi-label">Ãndice HHI</div><div class="kpi-value">${fmt(d.hhi)}</div><div class="kpi-sub">${d.hhi_nivel?.replace('_',' ')}</div></div>
      <div class="kpi blue"><div class="kpi-label">Clientes = 80% CxC</div><div class="kpi-value">${d.clientes_80pct}</div><div class="kpi-sub">de ${d.total_clientes} totales</div></div>
      <div class="kpi blue"><div class="kpi-label">CxC Total</div><div class="kpi-value sm">U$S ${fmtK(d.total_usd)}</div></div>
    `

    // Pareto curve
    const cls = d.clientes||[]
    if(charts.conc) charts.conc.destroy()
    charts.conc = new Chart(document.getElementById('chartConc'),{
      type:'bar',
      data:{
        labels:cls.slice(0,15).map(c=>c.cliente.substring(0,20)),
        datasets:[
          {type:'bar',label:'Deuda USD',data:cls.slice(0,15).map(c=>c.usd),backgroundColor:'rgba(56,189,248,0.6)',borderRadius:4,yAxisID:'y'},
          {type:'line',label:'% Acumulado',data:cls.slice(0,15).map(c=>c.cum),borderColor:'#f59e0b',tension:0.3,pointRadius:3,yAxisID:'y1'}
        ]
      },
      options:{responsive:true,maintainAspectRatio:false,scales:{x:{ticks:{color:'#64748b',maxRotation:45}},y:{ticks:{color:'#64748b',callback:v=>'$'+fmtK(v)},grid:{color:'rgba(255,255,255,0.05)'}},y1:{position:'right',min:0,max:100,ticks:{color:'#f59e0b',callback:v=>v+'%'},grid:{display:false}}},plugins:{legend:{labels:{color:'#94a3b8'}}}}
    })

    // Pie
    const top5 = cls.slice(0,5)
    const rest = {cliente:'Otros',usd:d.total_usd-top5.reduce((s,c)=>s+c.usd,0)}
    if(charts.concPie) charts.concPie.destroy()
    charts.concPie = new Chart(document.getElementById('chartConcPie'),{
      type:'pie',
      data:{
        labels:[...top5.map(c=>c.cliente.substring(0,20)),rest.cliente],
        datasets:[{data:[...top5.map(c=>c.usd),rest.usd],backgroundColor:['#38bdf8','#a78bfa','#f472b6','#2dd4bf','#f59e0b','#64748b'],borderWidth:0}]
      },
      options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{position:'right',labels:{color:'#94a3b8',font:{size:11}}}}}
    })
  } catch(e) { console.error('Concentration error:', e) }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// CLIENT PROFILE MODAL
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function openClient(name) {
  document.getElementById('clientModal').classList.add('open')
  document.getElementById('modalClientName').textContent = name
  document.getElementById('modalContent').innerHTML = '<div class="loading"><div class="spinner"></div>Cargando perfil...</div>'
  try {
    const res = await fetch(`${INT_URL}?action=client-profile&name=${encodeURIComponent(name)}`,{headers:hdr})
    const d = await res.json()
    const deu = d.deuda||{}
    document.getElementById('modalContent').innerHTML = `
      <div class="grid g3" style="margin-bottom:16px;">
        <div class="kpi blue"><div class="kpi-label">Deuda Total</div><div class="kpi-value sm">U$S ${fmt(deu.total_usd)}</div></div>
        <div class="kpi green"><div class="kpi-label">Corriente</div><div class="kpi-value sm">U$S ${fmt(deu.corriente)}</div></div>
        <div class="kpi red"><div class="kpi-label">Vencida</div><div class="kpi-value sm">U$S ${fmt(deu.vencida)}</div></div>
      </div>
      <div class="card" style="margin-bottom:16px;">
        <div class="card-head"><h3>Comprobantes Pendientes</h3></div>
        <table class="tbl"><thead><tr><th>Fecha</th><th>Comprobante</th><th>Mon</th><th class="num">Saldo</th><th class="num">DÃ­as</th></tr></thead><tbody>${
          (d.comprobantes||[]).map(c=>`<tr><td>${c.fecha}</td><td>${c.comprobante_nombre||''} ${c.numero||''}</td><td>${c.moneda_simbolo}</td><td class="num">${fmt(parseFloat(c.saldo))}</td><td class="num">${c.dias}d</td></tr>`).join('')
        }</tbody></table>
      </div>
      ${d.facturacion_mensual?.length ? `<div class="card"><div class="card-head"><h3>FacturaciÃ³n Mensual</h3></div><table class="tbl"><thead><tr><th>Mes</th><th class="num">USD</th></tr></thead><tbody>${
        d.facturacion_mensual.slice(0,12).map(f=>`<tr><td>${f.mes}</td><td class="num">${fmt(f.usd)}</td></tr>`).join('')
      }</tbody></table></div>` : ''}
    `
  } catch(e) { document.getElementById('modalContent').innerHTML = '<div style="color:var(--red);">Error cargando perfil</div>' }
}

function closeModal() { document.getElementById('clientModal').classList.remove('open') }
document.getElementById('clientModal').addEventListener('click', e => { if(e.target.classList.contains('modal-overlay')) closeModal() })

// Init
loadDashboard()
</script>
</body>
</html>
