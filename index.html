<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>La Buonora — CFO Dashboard v3</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=DM+Sans:ital,wght@0,400;0,500;0,700&family=JetBrains+Mono:wght@400;500;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0"></script>
    <style>
        :root {
            --bg: #0c0f1a;
            --surface: #151929;
            --surface-2: #1c2137;
            --surface-3: #242a42;
            --border: #2a3150;
            --text: #e2e8f0;
            --text-dim: #8892b0;
            --text-muted: #4a5578;
            --accent: #60a5fa;
            --accent-dim: rgba(96,165,250,0.12);
            --red: #ef4444;
            --red-dim: rgba(239,68,68,0.12);
            --red-glow: rgba(239,68,68,0.25);
            --green: #22c55e;
            --green-dim: rgba(34,197,94,0.12);
            --amber: #f59e0b;
            --amber-dim: rgba(245,158,11,0.12);
        }

        * { margin:0; padding:0; box-sizing:border-box; }

        body {
            font-family: 'DM Sans', -apple-system, sans-serif;
            background: var(--bg);
            color: var(--text);
            min-height: 100vh;
        }

        .mono { font-family: 'JetBrains Mono', monospace; }

        /* LAYOUT */
        .shell { max-width: 1440px; margin: 0 auto; padding: 20px; }

        /* HEADER */
        header {
            display: flex; justify-content: space-between; align-items: center;
            padding: 18px 24px; margin-bottom: 20px;
            background: var(--surface); border: 1px solid var(--border);
            border-radius: 12px;
        }
        .brand { display:flex; align-items:center; gap:14px; }
        .brand-icon {
            width:40px; height:40px; border-radius:10px;
            background: linear-gradient(135deg, var(--red), #b91c1c);
            display:flex; align-items:center; justify-content:center;
            font-size:18px; font-weight:700; color:#fff;
        }
        .brand h1 { font-size:1.25rem; font-weight:700; letter-spacing:-0.02em; }
        .brand p { font-size:0.78rem; color:var(--text-dim); margin-top:1px; }

        .header-actions { display:flex; gap:8px; align-items:center; }
        .badge {
            display:flex; align-items:center; gap:6px;
            padding:6px 14px; border-radius:20px; font-size:0.78rem; font-weight:500;
        }
        .badge-critical { background:var(--red-dim); color:var(--red); border:1px solid rgba(239,68,68,0.2); }
        .badge-ok { background:var(--green-dim); color:var(--green); border:1px solid rgba(34,197,94,0.2); }
        .badge-dot { width:7px;height:7px;border-radius:50%;background:currentColor; animation:blink 2s infinite; }
        @keyframes blink { 0%,100%{opacity:1} 50%{opacity:.4} }

        .btn {
            padding:8px 18px; border:1px solid var(--border); border-radius:8px;
            background:var(--surface-2); color:var(--text); font-size:0.82rem;
            cursor:pointer; font-weight:500; transition:all .15s;
            font-family:inherit;
        }
        .btn:hover { background:var(--surface-3); border-color:var(--accent); color:var(--accent); }
        .btn:disabled { opacity:.5; cursor:not-allowed; }

        /* KPI ROW */
        .kpi-row {
            display: grid; grid-template-columns: repeat(6, 1fr); gap: 14px;
            margin-bottom: 20px;
        }
        .kpi {
            background: var(--surface); border:1px solid var(--border);
            border-radius: 12px; padding: 18px 20px;
            position:relative; overflow:hidden;
        }
        .kpi-label { font-size:0.72rem; color:var(--text-dim); text-transform:uppercase; letter-spacing:0.06em; font-weight:500; }
        .kpi-value { font-size:1.7rem; font-weight:700; margin:6px 0 2px; letter-spacing:-0.03em; }
        .kpi-sub { font-size:0.75rem; color:var(--text-dim); }
        .kpi-value.negative { color:var(--red); }
        .kpi-value.positive { color:var(--green); }
        .kpi-value.warning { color:var(--amber); }
        .kpi-glow {
            position:absolute; top:-30px; right:-30px; width:80px; height:80px;
            border-radius:50%; filter:blur(30px); opacity:0.25; pointer-events:none;
        }

        /* GRID SECTIONS */
        .grid-main {
            display: grid; grid-template-columns: 2fr 1fr; gap: 16px;
            margin-bottom: 16px;
        }
        .grid-half {
            display: grid; grid-template-columns: 1fr 1fr; gap: 16px;
            margin-bottom: 16px;
        }
        .panel {
            background: var(--surface); border: 1px solid var(--border);
            border-radius: 12px; padding: 20px;
        }
        .panel-title {
            font-size:0.82rem; font-weight:600; color:var(--text-dim);
            text-transform:uppercase; letter-spacing:0.04em;
            margin-bottom:16px; display:flex; align-items:center; gap:8px;
        }
        .panel-title span { font-size:1rem; }

        /* BANK ACCOUNTS TABLE */
        .accounts-table { width:100%; }
        .accounts-table th {
            text-align:left; font-size:0.7rem; color:var(--text-muted);
            text-transform:uppercase; letter-spacing:0.06em;
            padding:0 0 10px; font-weight:500; border-bottom:1px solid var(--border);
        }
        .accounts-table td {
            padding:10px 0; font-size:0.85rem; border-bottom:1px solid rgba(42,49,80,0.5);
        }
        .accounts-table tr:last-child td { border-bottom:none; }

        /* PIPELINE BAR */
        .pipeline-bar { display:flex; height:10px; border-radius:5px; overflow:hidden; margin:12px 0; gap:2px; }
        .pipeline-seg-confirmed { background:var(--green); }
        .pipeline-seg-probable { background:var(--amber); }
        .pipeline-seg-potential { background:var(--accent); }
        .pipeline-legend { display:flex; gap:16px; flex-wrap:wrap; }
        .pipeline-legend-item { display:flex; align-items:center; gap:6px; font-size:0.78rem; color:var(--text-dim); }
        .pipeline-legend-dot { width:8px; height:8px; border-radius:2px; }

        /* PAYABLES LIST */
        .payable-row { display:flex; justify-content:space-between; align-items:center; padding:8px 0; border-bottom:1px solid rgba(42,49,80,0.4); }
        .payable-row:last-child { border-bottom:none; }
        .payable-name { font-size:0.82rem; }
        .payable-amount { font-family:'JetBrains Mono',monospace; font-size:0.82rem; color:var(--red); }

        /* ALERTS */
        .alert-card {
            padding:14px 16px; margin-bottom:10px; border-radius:8px;
            border-left:3px solid var(--red);
            background: linear-gradient(to right, var(--red-dim), transparent);
        }
        .alert-card.high { border-left-color:var(--amber); background:linear-gradient(to right, var(--amber-dim), transparent); }
        .alert-card.low { border-left-color:var(--accent); background:linear-gradient(to right, var(--accent-dim), transparent); }
        .alert-title { font-size:0.85rem; font-weight:600; margin-bottom:4px; }
        .alert-body { font-size:0.78rem; color:var(--text-dim); line-height:1.5; }
        .alert-rec { font-size:0.75rem; color:var(--amber); margin-top:6px; font-style:italic; }

        /* CHART TABS */
        .tabs { display:flex; gap:4px; }
        .tab {
            padding:5px 14px; border-radius:6px; font-size:0.75rem;
            background:var(--surface-2); color:var(--text-dim); border:1px solid var(--border);
            cursor:pointer; font-family:inherit; font-weight:500; transition:all .15s;
        }
        .tab.active { background:var(--accent-dim); color:var(--accent); border-color:rgba(96,165,250,0.3); }

        /* COST BREAKDOWN */
        .cost-item { display:flex; justify-content:space-between; padding:6px 0; font-size:0.82rem; }
        .cost-item .label { color:var(--text-dim); }
        .cost-item .val { font-family:'JetBrains Mono',monospace; }
        .cost-divider { border-top:1px solid var(--border); margin:6px 0; }
        .cost-item.total .label, .cost-item.total .val { font-weight:700; color:var(--text); }

        /* FOOTER */
        .footer { text-align:center; padding:24px 0 8px; font-size:0.72rem; color:var(--text-muted); }

        /* LOADING */
        .loading-state { display:flex; align-items:center; justify-content:center; padding:40px; color:var(--text-dim); gap:10px; }
        .spinner { width:18px;height:18px;border:2px solid var(--border);border-top-color:var(--accent);border-radius:50%;animation:spin .7s linear infinite; }
        @keyframes spin { to{transform:rotate(360deg)} }

        /* RESPONSIVE */
        @media(max-width:1200px) { .kpi-row{grid-template-columns:repeat(3,1fr);} .grid-main{grid-template-columns:1fr;} }
        @media(max-width:768px) { .kpi-row{grid-template-columns:repeat(2,1fr);} .grid-half{grid-template-columns:1fr;} header{flex-direction:column;align-items:flex-start;gap:12px;} }
    </style>
</head>
<body>
<div class="shell">

    <!-- HEADER -->
    <header>
        <div class="brand">
            <div class="brand-icon">LB</div>
            <div>
                <h1>La Buonora â€” CFO</h1>
                <p id="header-subtitle">Agente Financiero v3 · Datos ZetaSoftware</p>
            </div>
        </div>
        <div class="header-actions">
            <div class="badge" id="sync-badge" style="background:rgba(96,165,250,0.1);color:#60a5fa;border:1px solid rgba(96,165,250,0.2);font-size:0.7rem;padding:4px 10px;">⟳ Sync: —</div>
            <div class="badge badge-critical" id="status-badge">
                <div class="badge-dot"></div>
                <span>CARGANDO</span>
            </div>
            <button class="btn" onclick="refreshDashboard()">â†» Actualizar</button>
            <button class="btn" onclick="runAnalysis()" id="btn-analysis">â–¶ AnÃ¡lisis</button>
        </div>
    </header>

    <!-- KPI ROW -->
    <div class="kpi-row" id="kpi-row">
        <div class="loading-state" style="grid-column:1/-1"><div class="spinner"></div>Cargando datos financierosâ€¦</div>
    </div>

    <!-- MAIN GRID: Chart + Right sidebar -->
    <div class="grid-main">
        <!-- FORECAST CHART -->
        <div class="panel">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:14px;">
                <div class="panel-title" style="margin-bottom:0"><span>ðŸ“ˆ</span> ProyecciÃ³n de Cash Flow</div>
                <div class="tabs">
                    <button class="tab active" onclick="changeForecast(30,this)">30d</button>
                    <button class="tab" onclick="changeForecast(60,this)">60d</button>
                    <button class="tab" onclick="changeForecast(90,this)">90d</button>
                </div>
            </div>
            <canvas id="forecastChart" height="260"></canvas>
        </div>

        <!-- RIGHT SIDEBAR: Bank + Pipeline -->
        <div style="display:flex;flex-direction:column;gap:16px;">

            <!-- BANK ACCOUNTS -->
            <div class="panel">
                <div class="panel-title"><span>ðŸ¦</span> Posicion Financiera</div>
                <table class="accounts-table" id="accounts-table">
                    <tr><td colspan="3" class="loading-state"><div class="spinner"></div></td></tr>
                </table>
            </div>

            <!-- PIPELINE -->
            <div class="panel">
                <div class="panel-title"><span>ðŸ“Š</span> Pipeline Comercial</div>
                <div id="pipeline-container">
                    <div class="loading-state"><div class="spinner"></div></div>
                </div>
            </div>
        </div>
    </div>

    <!-- SECOND ROW: Costs + Payables + Alerts -->
    <div class="grid-half" style="grid-template-columns: 1fr 1fr 1fr; display:grid; gap:16px; margin-bottom:16px;" id="bottom-grid">

        <!-- COST BREAKDOWN -->
        <div class="panel">
            <div class="panel-title"><span>ðŸ”¥</span> Estructura de Costos Mensual</div>
            <div id="costs-container">
                <div class="loading-state"><div class="spinner"></div></div>
            </div>
        </div>

        <!-- TOP PAYABLES -->
        <div class="panel">
            <div class="panel-title"><span>ðŸ“‹</span> Top CxP — Proveedores (Zeta)</div>
            <div id="payables-container" style="max-height:280px;overflow-y:auto;">
                <div class="loading-state"><div class="spinner"></div></div>
            </div>
        </div>

        <!-- ALERTS -->
        <div class="panel">
            <div class="panel-title"><span>ðŸš¨</span> Alertas Activas</div>
            <div id="alerts-container" style="max-height:280px;overflow-y:auto;">
                <div class="loading-state"><div class="spinner"></div></div>
            </div>
        </div>
    </div>

    <div class="footer" id="footer">Dashboard v3.0 · ZetaSoftware &bull; Ãšltima actualizaciÃ³n: â€”</div>
</div>

<script>
// ============================================
// CONFIG
// ============================================
const SUPABASE_URL = "https://qnjizqowddtvzzfillmo.supabase.co";
const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InFuaml6cW93ZGR0dnp6ZmlsbG1vIiwicm9sZSI6ImFub24iLCJpYXQiOjE3MzQ3MjA1OTYsImV4cCI6MjA1MDI5NjU5Nn0.NqZCkIYB1S2rUDYWwqt7RKWQ4SdmxXBxIw-1xqXd8zo";

const sb = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
let forecastChart = null;

// ============================================
// API HELPER
// ============================================
async function api(action, params = {}) {
    const qs = new URLSearchParams({ action, ...params }).toString();
    const res = await fetch(`${SUPABASE_URL}/functions/v1/finance-agent-api-v2?${qs}`, {
        headers: { 'Authorization': `Bearer ${SUPABASE_ANON_KEY}`, 'Content-Type': 'application/json' }
    });
    if (!res.ok) throw new Error(`HTTP ${res.status}`);
    return res.json();
}

// ============================================
// FORMAT HELPERS
// ============================================
const fmtUSD = (v, dec=0) => {
    if (v == null) return 'â€”';
    const abs = Math.abs(v);
    const str = abs >= 1000 ? abs.toLocaleString('en-US', {minimumFractionDigits:dec, maximumFractionDigits:dec}) : abs.toFixed(dec);
    return v < 0 ? `-$${str}` : `$${str}`;
};
const fmtK = (v) => {
    if (v == null) return 'â€”';
    const abs = Math.abs(v);
    const s = abs >= 1000 ? (abs/1000).toFixed(1) + 'K' : abs.toFixed(0);
    return v < 0 ? `-$${s}` : `$${s}`;
};
const cls = (v) => v < 0 ? 'negative' : v > 0 ? 'positive' : '';

// ============================================
// MAIN REFRESH
// ============================================
async function refreshDashboard() {
    try {
        const data = await api('dashboard');
        console.log('Dashboard data:', data);

        renderKPIs(data);
        renderChart(data.forecast || []);
        renderAccounts(data);
        renderPipeline(data);
        renderCosts(data);
        renderPayables(data);
        renderAlerts(data.active_alerts || []);

        // Status badge
        const fh = data.financial_health || {};
        const badge = document.getElementById('status-badge');
        if (fh.status === 'critical') {
            badge.className = 'badge badge-critical';
            badge.querySelector('span').textContent = 'CRÃTICO';
        } else if (fh.status === 'warning') {
            badge.className = 'badge badge-critical';
            badge.querySelector('span').textContent = 'ALERTA';
        } else {
            badge.className = 'badge badge-ok';
            badge.querySelector('span').textContent = 'SALUDABLE';
        }

        
        // Update sync badge
        if (data.last_zeta_sync) {
            const syncDate = new Date(data.last_zeta_sync);
            const ago = Math.round((Date.now() - syncDate.getTime()) / 60000);
            const agoText = ago < 60 ? ago + 'min' : Math.round(ago/60) + 'h';
            document.getElementById('sync-badge').textContent = 'Zeta: ' + agoText + ' atras';
        }
        if (data.financial_health) {
            document.getElementById('header-subtitle').textContent = 
                'Agente Financiero v3 · Datos ZetaSoftware · TC ref: $' + (data.financial_health.tc_reference || '?');
        }

        document.getElementById('footer').innerHTML =
            `Dashboard v3.0 · ZetaSoftware &bull; Ãšltima actualizaciÃ³n: ${new Date().toLocaleString('es-UY')} &bull; MÃ©todo: ${data.forecast_method || 'â€”'}`;
    } catch(e) {
        console.error('Dashboard error:', e);
        document.getElementById('kpi-row').innerHTML = `<div class="loading-state" style="grid-column:1/-1;color:var(--red)">âš  Error cargando: ${e.message}</div>`;
    }
}

// ============================================
// KPI CARDS
// ============================================
function renderKPIs(data) {
    const fh = data.financial_health || {};
    const pipe = data.pipeline || {};
    const vr = data.ventas_resumen || {};

    const kpis = [
        {
            label: 'Banco',
            value: fmtK(fh.total_cash),
            cls: cls(fh.total_cash),
            sub: `${(fh.days_of_operation||0).toFixed(0)} dias op.`,
            glow: fh.total_cash < 0 ? 'var(--red)' : 'var(--green)'
        },
        {
            label: 'CxC (por cobrar)',
            value: fmtK(fh.receivables_usd),
            cls: 'positive',
            sub: `${(data.cxc_by_currency||[]).reduce((s,c) => s + (c.comprobantes||0), 0)} comp.`,
            glow: 'var(--green)'
        },
        {
            label: 'CxP (por pagar)',
            value: fmtK(-(fh.payables_usd || 0)),
            cls: 'negative',
            sub: `${(data.cxp_by_currency||[]).reduce((s,c) => s + (c.comprobantes||0), 0)} comp.`,
            glow: 'var(--red)'
        },
        {
            label: 'Posicion Neta',
            value: fmtK(fh.net_position),
            cls: cls(fh.net_position),
            sub: 'Banco + CxC - CxP',
            glow: fh.net_position < 0 ? 'var(--red)' : 'var(--green)'
        },
        {
            label: 'Facturacion Mes',
            value: vr.total_usd ? ('U$S ' + Math.round(vr.total_usd).toLocaleString()) : fmtK(vr.total_pesos || 0),
            cls: 'positive',
            sub: vr.total_pesos > 0 ? ('+ $' + Math.round(vr.total_pesos).toLocaleString() + ' UYU') : ((vr.cant_facturas || 0) + ' facturas'),
            glow: 'var(--accent)'
        },
        {
            label: 'Burn Rate',
            value: fmtK(fh.monthly_burn_rate),
            cls: 'warning',
            sub: 'Costos fijos + var.',
            glow: 'var(--amber)'
        }
    ];

    document.getElementById('kpi-row').innerHTML = kpis.map(k => `
        <div class="kpi">
            <div class="kpi-glow" style="background:${k.glow}"></div>
            <div class="kpi-label">${k.label}</div>
            <div class="kpi-value ${k.cls} mono">${k.value}</div>
            <div class="kpi-sub">${k.sub}</div>
        </div>
    `).join('');
}

// ============================================
// FORECAST CHART
// ============================================
function renderChart(forecast) {
    if (!forecast?.length) return;

    const labels = forecast.map(f => {
        const d = new Date(f.date);
        return d.toLocaleDateString('es-UY', {day:'numeric', month:'short'});
    });
    const balances = forecast.map(f => f.cumulative_balance);
    const zero = forecast.map(() => 0);

    const ctx = document.getElementById('forecastChart').getContext('2d');
    if (forecastChart) forecastChart.destroy();

    // Gradient
    const grad = ctx.createLinearGradient(0, 0, 0, 260);
    const allNeg = balances.every(b => b < 0);
    if (allNeg) {
        grad.addColorStop(0, 'rgba(239,68,68,0.15)');
        grad.addColorStop(1, 'rgba(239,68,68,0.01)');
    } else {
        grad.addColorStop(0, 'rgba(96,165,250,0.18)');
        grad.addColorStop(1, 'rgba(96,165,250,0.01)');
    }

    forecastChart = new Chart(ctx, {
        type: 'line',
        data: {
            labels,
            datasets: [
                {
                    label: 'Balance Proyectado',
                    data: balances,
                    borderColor: allNeg ? '#ef4444' : '#60a5fa',
                    backgroundColor: grad,
                    fill: true, tension: 0.35, borderWidth: 2.5,
                    pointRadius: 0, pointHitRadius: 10,
                },
                {
                    label: 'Cero',
                    data: zero,
                    borderColor: 'rgba(255,255,255,0.1)',
                    borderWidth: 1, borderDash: [4,4],
                    pointRadius: 0, fill: false,
                }
            ]
        },
        options: {
            responsive: true, maintainAspectRatio: false,
            interaction: { intersect: false, mode: 'index' },
            plugins: {
                legend: { display: false },
                tooltip: {
                    backgroundColor: '#1c2137', borderColor: '#2a3150', borderWidth: 1,
                    titleFont: { family: 'DM Sans' }, bodyFont: { family: 'JetBrains Mono', size: 12 },
                    callbacks: {
                        label: (c) => c.datasetIndex === 0 ? 'Balance: ' + fmtUSD(c.parsed.y) : null,
                    }
                }
            },
            scales: {
                x: { grid: { color:'rgba(42,49,80,0.4)' }, ticks:{ color:'#4a5578', font:{size:10}, maxTicksLimit:10 } },
                y: { grid: { color:'rgba(42,49,80,0.4)' }, ticks:{ color:'#4a5578', font:{family:'JetBrains Mono',size:10}, callback:v=>fmtK(v) } }
            }
        }
    });
}

async function changeForecast(days, btn) {
    document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
    btn.classList.add('active');
    try {
        const data = await api('forecast', { days });
        renderChart(data.forecast || []);
    } catch(e) { console.error('Forecast error:', e); }
}

// ============================================
// BANK ACCOUNTS
// ============================================
function renderAccounts(data) {
    const fh = data.financial_health || {};
    const cxcByCur = data.cxc_by_currency || [];
    const cxpByCur = data.cxp_by_currency || [];
    const banks = data.bank_accounts || [];

    let html = '<thead><tr><th>Concepto</th><th style="text-align:right">Monto</th></tr></thead><tbody>';
    for (const b of banks) {
        html += '<tr><td style="color:var(--text-dim);font-size:0.8rem">' + b.name + '</td>' +
            '<td style="text-align:right" class="mono ' + cls(parseFloat(b.balance)) + '">' + fmtUSD(parseFloat(b.balance)) + '</td></tr>';
    }
    html += '<tr style="border-top:1px solid var(--border)"><td style="font-weight:600">Total Banco</td>' +
        '<td style="text-align:right;font-weight:700" class="mono ' + cls(fh.total_cash) + '">' + fmtUSD(fh.total_cash) + '</td></tr>';

    html += '<tr style="border-top:2px solid var(--border)"><td colspan="2" style="font-size:0.72rem;color:var(--text-muted);padding-top:8px">CUENTAS POR COBRAR</td></tr>';
    for (const c of cxcByCur) {
        html += '<tr><td style="color:var(--text-dim);font-size:0.8rem">' + c.moneda_simbolo + ' (' + c.comprobantes + ' comp.)</td>' +
            '<td style="text-align:right" class="mono positive">' + c.moneda_simbolo + ' ' + Math.round(c.total_saldo).toLocaleString() + '</td></tr>';
    }
    html += '<tr><td style="font-weight:600">Total CxC (USD)</td>' +
        '<td style="text-align:right;font-weight:700" class="mono positive">' + fmtUSD(fh.receivables_usd) + '</td></tr>';

    html += '<tr style="border-top:2px solid var(--border)"><td colspan="2" style="font-size:0.72rem;color:var(--text-muted);padding-top:8px">CUENTAS POR PAGAR</td></tr>';
    for (const c of cxpByCur) {
        html += '<tr><td style="color:var(--text-dim);font-size:0.8rem">' + c.moneda_simbolo + ' (' + c.comprobantes + ' comp.)</td>' +
            '<td style="text-align:right" class="mono negative">-' + c.moneda_simbolo + ' ' + Math.round(c.total_saldo).toLocaleString() + '</td></tr>';
    }
    html += '<tr><td style="font-weight:600">Total CxP (USD)</td>' +
        '<td style="text-align:right;font-weight:700" class="mono negative">' + fmtUSD(-(fh.payables_usd||0)) + '</td></tr>';

    html += '<tr style="border-top:2px solid var(--border)"><td style="font-weight:700">Posicion Neta</td>' +
        '<td style="text-align:right;font-weight:700;font-size:1.05rem" class="mono ' + cls(fh.net_position) + '">' + fmtUSD(fh.net_position) + '</td></tr>';
    html += '</tbody>';
    document.getElementById('accounts-table').innerHTML = html;
}

// ============================================
// PIPELINE
// ============================================
function renderPipeline(data) {
    const pipe = data.pipeline || {};
    const c = pipe.confirmed_revenue || 0;
    const p = pipe.probable_revenue || 0;
    const pot = pipe.potential_revenue || 0;
    const total = c + p + pot || 1;

    const pctC = (c/total*100).toFixed(0);
    const pctP = (p/total*100).toFixed(0);
    const pctPot = (pot/total*100).toFixed(0);

    document.getElementById('pipeline-container').innerHTML = `
        <div class="pipeline-bar">
            ${c > 0 ? `<div class="pipeline-seg-confirmed" style="width:${pctC}%"></div>` : ''}
            ${p > 0 ? `<div class="pipeline-seg-probable" style="width:${pctP}%"></div>` : ''}
            ${pot > 0 ? `<div class="pipeline-seg-potential" style="width:${pctPot}%"></div>` : ''}
        </div>
        <div class="pipeline-legend">
            <div class="pipeline-legend-item">
                <div class="pipeline-legend-dot" style="background:var(--green)"></div>
                Confirmado: ${fmtK(c)}
            </div>
            <div class="pipeline-legend-item">
                <div class="pipeline-legend-dot" style="background:var(--amber)"></div>
                Probable: ${fmtK(p)}
            </div>
            <div class="pipeline-legend-item">
                <div class="pipeline-legend-dot" style="background:var(--accent)"></div>
                Potencial: ${fmtK(pot)}
            </div>
        </div>
        <div style="margin-top:12px;padding-top:10px;border-top:1px solid var(--border);display:flex;justify-content:space-between;">
            <span style="font-size:0.78rem;color:var(--text-dim)">Total Ponderado</span>
            <span class="mono" style="font-weight:700;color:var(--accent)">${fmtK(pipe.total_weighted_pipeline||0)}</span>
        </div>
        ${(pipe.committed_costs||0) > 0 ? `<div style="display:flex;justify-content:space-between;margin-top:4px;">
            <span style="font-size:0.78rem;color:var(--text-dim)">Costos Comprometidos</span>
            <span class="mono negative" style="font-size:0.85rem">${fmtK(-(pipe.committed_costs||0))}</span>
        </div>` : ''}
        <div style="display:flex;justify-content:space-between;margin-top:4px;">
            <span style="font-size:0.78rem;color:var(--text-dim)">ProducciÃ³n Activa</span>
            <span class="mono" style="font-size:0.85rem">${pipe.active_production_jobs || 0} trabajos</span>
        </div>
    `;
}

// ============================================
// COST BREAKDOWN
// ============================================
function renderCosts(data) {
    // Use config values from financial_parameters
    // These are embedded in the burn rate, but we can show the structure
    const fh = data.financial_health || {};
    const burnRate = fh.monthly_burn_rate || 0;
    
    // Known breakdown from COSTOS.xlsx
    const fixed = 17024;
    const variable = 37813;
    const interest = 1457;
    const total = fixed + variable + interest;

    document.getElementById('costs-container').innerHTML = `
        <div class="cost-item"><span class="label">Costos Fijos Operativos</span><span class="val mono">${fmtUSD(fixed)}</span></div>
        <div style="padding-left:16px;">
            <div class="cost-item"><span class="label" style="font-size:0.75rem">Alquiler, servicios, seguros</span><span class="val mono" style="font-size:0.78rem">$5,280</span></div>
            <div class="cost-item"><span class="label" style="font-size:0.75rem">Sueldos administraciÃ³n</span><span class="val mono" style="font-size:0.78rem">$5,546</span></div>
            <div class="cost-item"><span class="label" style="font-size:0.75rem">Honorarios, software, otros</span><span class="val mono" style="font-size:0.78rem">$1,479</span></div>
            <div class="cost-item"><span class="label" style="font-size:0.75rem">Retiro socio (GastÃ³n)</span><span class="val mono" style="font-size:0.78rem">$4,719</span></div>
        </div>
        <div class="cost-divider"></div>
        <div class="cost-item"><span class="label">Costos Variables (producciÃ³n)</span><span class="val mono">${fmtUSD(variable)}</span></div>
        <div style="padding-left:16px;">
            <div class="cost-item"><span class="label" style="font-size:0.75rem">Sueldos producciÃ³n (9 op.)</span><span class="val mono" style="font-size:0.78rem">$13,277</span></div>
            <div class="cost-item"><span class="label" style="font-size:0.75rem">Sueldos obra (3 inst.)</span><span class="val mono" style="font-size:0.78rem">$5,645</span></div>
            <div class="cost-item"><span class="label" style="font-size:0.75rem">Tercerizados, materiales</span><span class="val mono" style="font-size:0.78rem">$18,891</span></div>
        </div>
        <div class="cost-divider"></div>
        <div class="cost-item"><span class="label">Intereses Sobregiro</span><span class="val mono" style="color:var(--red)">${fmtUSD(interest)}</span></div>
        <div class="cost-divider" style="border-top-width:2px"></div>
        <div class="cost-item total"><span class="label">TOTAL MENSUAL</span><span class="val mono" style="color:var(--red)">${fmtUSD(total)}</span></div>
    `;
}

// ============================================
// TOP PAYABLES
// ============================================
function renderPayables(data) {
    const topProv = data.cxp_top || [];
    if (!topProv.length) {
        document.getElementById('payables-container').innerHTML = '<div style="color:var(--text-muted);text-align:center;padding:20px;">Sin datos CxP</div>';
        return;
    }
    document.getElementById('payables-container').innerHTML = topProv.slice(0, 10).map(function(p) {
        return '<div style="display:flex;justify-content:space-between;padding:6px 0;font-size:0.8rem;border-bottom:1px solid rgba(42,49,80,0.3);">' +
            '<span style="color:var(--text-dim);flex:1;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;">' + p.proveedor + '</span>' +
            '<span style="font-size:0.65rem;padding:2px 6px;border-radius:4px;margin-left:6px;font-weight:600;' + 
                (p.moneda === 'U$S' ? 'background:rgba(96,165,250,0.12);color:#60a5fa' : 'background:rgba(34,197,94,0.12);color:#22c55e') + '">' + p.moneda + '</span>' +
            '<span class="mono negative" style="font-weight:600;margin-left:10px;white-space:nowrap;">-' + p.moneda + ' ' + Math.round(p.total).toLocaleString() + '</span></div>';
    }).join('');
}

// ============================================
// ALERTS
// ============================================
function renderAlerts(alerts) {
    if (!alerts?.length) {
        document.getElementById('alerts-container').innerHTML = '<div style="color:var(--text-muted);text-align:center;padding:20px;">âœ… Sin alertas activas</div>';
        return;
    }
    document.getElementById('alerts-container').innerHTML = alerts.map(a => `
        <div class="alert-card ${a.severity}">
            <div class="alert-title">${a.title}</div>
            <div class="alert-body">${a.description}</div>
            ${a.recommendation ? `<div class="alert-rec">ðŸ’¡ ${a.recommendation}</div>` : ''}
        </div>
    `).join('');
}

// ============================================
// ANALYSIS
// ============================================
async function runAnalysis() {
    const btn = document.getElementById('btn-analysis');
    btn.disabled = true; btn.textContent = 'â³ Analizandoâ€¦';
    try {
        const data = await api('analyze');
        const a = data.analysis || {};
        const msg = `AnÃ¡lisis completado\n\nIngresos 30d: ${fmtUSD(a.summary?.total_income)}\nGastos 30d: ${fmtUSD(a.summary?.total_expenses)}\nInsights: ${(a.insights||[]).length}`;
        alert(msg);
        await refreshDashboard();
    } catch(e) { alert('Error: ' + e.message); }
    finally { btn.disabled = false; btn.textContent = 'â–¶ AnÃ¡lisis'; }
}

// ============================================
// INIT
// ============================================
setInterval(refreshDashboard, 90000);
window.addEventListener('load', refreshDashboard);
</script>
</body>
</html>
